name: PR Tests

on:
  pull_request:
    branches:
      - '**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

jobs:
  tests:
    name: Tests (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ '8', '21' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Ensure the runner uses JDK 21 as the default when matrix is '8',
      # while JDK 8 is available for Gradle toolchains
      - name: Install JDK 8 for Gradle toolchains (matrix=8)
        if: matrix.java == '8'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - name: Set runner default JDK to 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache JFR samples
        id: cache-jfr
        uses: actions/cache@v4
        with:
          path: |
            demo/src/test/resources/test-ap.jfr
            demo/src/test/resources/test-jfr.jfr
          key: jfr-samples-v1

      - name: Setup Gradle caching
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare test resources
        run: bash ./get_resources.sh

      # Composite build resolves the plugin from source; no local publish needed

      - name: Build and test (JDK ${{ matrix.java }})
        run: |
          java -version
          if [ "${{ matrix.java }}" = "8" ]; then
            ./gradlew --stacktrace --no-daemon -x spotlessCheck :parser:compileJava :parser:test8
          else
            ./gradlew --stacktrace --no-daemon build
          fi

      - name: Plugin unit tests (JDK 21)
        if: matrix.java == '21'
        run: |
          ./gradlew -p jafar-gradle-plugin --stacktrace --no-daemon test

      - name: Prepare artifacts (collect XML/HTML; add placeholder if empty)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/xml artifacts/html
          shopt -s globstar nullglob
          copied=0
          for f in **/build/test-results/test/*.xml **/build/test-results/test8/*.xml; do
            cp "$f" artifacts/xml/
            copied=1
          done
          if [ "$copied" -eq 0 ]; then
            echo '<testsuite name="placeholder" tests="0" failures="0" errors="0" skipped="0"/>' > artifacts/xml/placeholder.xml
          fi
          for d in **/build/reports/tests/test **/build/reports/tests/test8; do
            if [ -d "$d" ]; then
              dest="artifacts/html/$(basename "$d")"
              mkdir -p "$dest"
              cp -R "$d"/. "$dest"/
            fi
          done

      - name: Upload JUnit XML reports (JDK ${{ matrix.java }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-xml-jdk-${{ matrix.java }}
          path: artifacts/xml
          retention-days: 14

      - name: Upload HTML test reports (JDK ${{ matrix.java }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-html-jdk-${{ matrix.java }}
          path: artifacts/html
          retention-days: 14

  aggregate-test-report:
    name: Combined Test Report
    runs-on: ubuntu-latest
    needs: tests
    if: always()
    permissions:
      contents: read
      pull-requests: write
      checks: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all JUnit XML artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: junit-xml-jdk-*
          merge-multiple: true
          path: reports

      - name: Ensure report XML presence
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports
          shopt -s globstar nullglob
          count=$(ls -1 reports/**/*.xml 2>/dev/null | wc -l | tr -d ' ')
          if [ "$count" = "0" ]; then
            echo '<testsuite name="placeholder" tests="0" failures="0" errors="0" skipped="0"/>' > reports/placeholder.xml
          fi

      - name: Publish combined JUnit PR annotations
        uses: dorny/test-reporter@v1
        with:
          name: Combined JUnit Test Report
          path: reports/**/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: Comment summary on PR
        if: always() && github.event_name == 'pull_request'
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/**/*.xml
          check_name: Combined JUnit Test Report
          comment_mode: update
          fail_on: never
