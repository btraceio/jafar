name: PR Tests

on:
  pull_request:
    branches:
      - '**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

jobs:
  tests:
    name: Tests (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ '8', '21' ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Ensure the runner uses JDK 21 as the default when matrix is '8',
      # while JDK 8 is available for Gradle toolchains
      - name: Install JDK 8 for Gradle toolchains (matrix=8)
        if: matrix.java == '8'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - name: Set runner default JDK to 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache JFR samples
        id: cache-jfr
        uses: actions/cache@v4
        with:
          path: |
            demo/src/test/resources/test-ap.jfr
            demo/src/test/resources/test-jfr.jfr
          key: jfr-samples-v1

      - name: Setup Gradle caching
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare test resources
        run: bash ./get_resources.sh

      - name: Build and test (JDK ${{ matrix.java }})
        run: |
          java -version
          if [ "${{ matrix.java }}" = "8" ]; then
            ./gradlew --stacktrace --no-daemon -x spotlessCheck :parser:compileJava :parser:test8
          else
            ./gradlew --stacktrace --no-daemon build
          fi

      - name: Check API compatibility (JDK 21)
        if: matrix.java == '21'
        run: |
          ./gradlew --stacktrace --no-daemon :jfr-shell:japicmp --continue

      - name: Upload japicmp report (JDK 21)
        if: always() && matrix.java == '21'
        uses: actions/upload-artifact@v4
        with:
          name: japicmp-report
          path: jfr-shell/build/reports/japicmp.*
          retention-days: 14

      - name: Publish parser to mavenLocal for plugin tests (JDK 21)
        if: matrix.java == '21'
        run: |
          ./gradlew --stacktrace --no-daemon publishToMavenLocal

      - name: Plugin unit tests (JDK 21)
        if: matrix.java == '21'
        run: |
          ./gradlew -p jafar-gradle-plugin --stacktrace --no-daemon test

      - name: Build backend JARs for TCK (JDK 21)
        if: matrix.java == '21'
        run: |
          ./gradlew --stacktrace --no-daemon :jfr-shell-jafar:jar :jfr-shell-jdk:jar

      - name: Run TCK against Jafar backend (JDK 21)
        if: matrix.java == '21'
        run: |
          JAFAR_JAR=$(ls jfr-shell-jafar/build/libs/jfr-shell-jafar-*.jar | grep -v sources | grep -v javadoc | head -1)
          if [ -z "$JAFAR_JAR" ]; then echo "Error: Jafar backend JAR not found"; exit 1; fi
          ./gradlew --stacktrace --no-daemon :jfr-shell-tck:runTck -PbackendJar="$JAFAR_JAR"

      - name: Run TCK against JDK backend (JDK 21)
        if: matrix.java == '21'
        run: |
          JDK_JAR=$(ls jfr-shell-jdk/build/libs/jfr-shell-jdk-*.jar | grep -v sources | grep -v javadoc | head -1)
          if [ -z "$JDK_JAR" ]; then echo "Error: JDK backend JAR not found"; exit 1; fi
          ./gradlew --stacktrace --no-daemon :jfr-shell-tck:runTck -PbackendJar="$JDK_JAR"

      - name: Prepare artifacts (collect XML/HTML; add placeholder if empty)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/xml artifacts/html
          shopt -s globstar nullglob
          copied=0
          for f in **/build/test-results/test/*.xml **/build/test-results/test8/*.xml; do
            cp "$f" artifacts/xml/
            copied=1
          done
          if [ "$copied" -eq 0 ]; then
            echo '<testsuite name="placeholder" tests="0" failures="0" errors="0" skipped="0"/>' > artifacts/xml/placeholder.xml
          fi
          for d in **/build/reports/tests/test **/build/reports/tests/test8; do
            if [ -d "$d" ]; then
              dest="artifacts/html/$(basename "$d")"
              mkdir -p "$dest"
              cp -R "$d"/. "$dest"/
            fi
          done

      - name: Upload JUnit XML reports (JDK ${{ matrix.java }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-xml-jdk-${{ matrix.java }}
          path: artifacts/xml
          retention-days: 14

      - name: Upload HTML test reports (JDK ${{ matrix.java }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-html-jdk-${{ matrix.java }}
          path: artifacts/html
          retention-days: 14

  aggregate-test-report:
    name: Combined Test Report
    runs-on: ubuntu-latest
    needs: tests
    if: always()
    permissions:
      contents: read
      pull-requests: write
      checks: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all JUnit XML artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: junit-xml-jdk-*
          merge-multiple: true
          path: reports

      - name: Ensure report XML presence
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports
          shopt -s globstar nullglob
          count=$(ls -1 reports/**/*.xml 2>/dev/null | wc -l | tr -d ' ')
          if [ "$count" = "0" ]; then
            echo '<testsuite name="placeholder" tests="0" failures="0" errors="0" skipped="0"/>' > reports/placeholder.xml
          fi

      - name: Publish combined JUnit PR annotations
        uses: dorny/test-reporter@v1
        with:
          name: Combined JUnit Test Report
          path: reports/**/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: Analyze test results and build combined PR comment (same-repo PRs only)
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        id: build_comment
        shell: bash
        env:
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import glob, xml.etree.ElementTree as ET, os
          tests=fail=errs=skipped=0
          for path in glob.glob('reports/**/*.xml', recursive=True):
              try:
                  tree=ET.parse(path)
                  root=tree.getroot()
                  suites=[]
                  if root.tag.endswith('testsuite'):
                      suites=[root]
                  else:
                      suites=[el for el in root if el.tag.endswith('testsuite')]
                  for s in suites:
                      tests += int(s.attrib.get('tests', 0))
                      fail  += int(s.attrib.get('failures', 0))
                      errs  += int(s.attrib.get('errors', 0))
                      skipped += int(s.attrib.get('skipped', 0))
              except Exception:
                  pass
          with open('summary.env','w') as f:
              f.write(f"TOTAL={tests}\nFAIL={fail}\nERR={errs}\nSKIP={skipped}\nPASS={tests-fail-errs-skipped}\n")
          PY
          # shellcheck disable=SC1091
          . summary.env

          # Build HTML artifact links
          api="https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts"
          json=$(curl -sSf -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$api")
          id8=$(echo "$json" | jq -r --arg name "junit-html-jdk-8" '.artifacts[] | select(.name==$name) | .id' | head -n1)
          id21=$(echo "$json" | jq -r --arg name "junit-html-jdk-21" '.artifacts[] | select(.name==$name) | .id' | head -n1)
          url8=""; url21=""
          if [ -n "${id8:-}" ] && [ "${id8}" != "null" ]; then url8="https://github.com/${REPO}/actions/runs/${RUN_ID}/artifacts/${id8}"; fi
          if [ -n "${id21:-}" ] && [ "${id21}" != "null" ]; then url21="https://github.com/${REPO}/actions/runs/${RUN_ID}/artifacts/${id21}"; fi

          {
            echo "<!-- test-summary-marker -->"
            echo "### Combined JUnit Test Report"
            echo ""
            echo "- Total: ${TOTAL}"
            echo "- Passed: ${PASS}"
            echo "- Failures: ${FAIL}"
            echo "- Errors: ${ERR}"
            echo "- Skipped: ${SKIP}"
            echo ""
            echo "### HTML Test Reports"
            echo "Run artifacts: https://github.com/${REPO}/actions/runs/${RUN_ID}"
            if [ -n "${url8:-}" ]; then
              echo "- JDK 8: [HTML report artifact](${url8})"
            else
              echo "- JDK 8: (artifact not found)"
            fi
            if [ -n "${url21:-}" ]; then
              echo "- JDK 21: [HTML report artifact](${url21})"
            else
              echo "- JDK 21: (artifact not found)"
            fi
          } | tee combined_comment.md
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat combined_comment.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Find existing combined report comment
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: <!-- test-summary-marker -->

      - name: Post/update combined report comment
        if: |
          always() &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: ${{ steps.build_comment.outputs.body }}
