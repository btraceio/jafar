name: Publish JBang Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: false
        default: ''

permissions:
  contents: read
  packages: write

jobs:
  publish-github-packages:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build shadow JAR
        run: ./gradlew :jfr-shell:shadowJar --no-daemon

      - name: Publish to GitHub Packages
        run: ./gradlew :jfr-shell:publishMavenPublicationToGitHubPackagesRepository --no-daemon
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Upload shadow JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jfr-shell-jar
          path: jfr-shell/build/libs/jfr-shell-*.jar
          retention-days: 30

  trigger-jitpack:
    name: Trigger JitPack Build
    runs-on: ubuntu-latest
    needs: publish-github-packages

    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="main-SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Trigger JitPack build
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Triggering JitPack build for version: $VERSION"

          # Trigger build by fetching the build log (initiates build if not cached)
          curl -f -s -o /tmp/jitpack-build.log \
            "https://jitpack.io/com/github/btraceio/jfr-shell/$VERSION/build.log" || {
            echo "JitPack build trigger failed. Build log:"
            cat /tmp/jitpack-build.log
            exit 1
          }

          echo "JitPack build triggered successfully"
          echo "View build status at: https://jitpack.io/com/github/btraceio/jfr-shell/$VERSION"

      - name: Verify JitPack artifact
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Waiting for JitPack artifact to be available..."

          # Wait up to 5 minutes for artifact to be available
          for i in {1..30}; do
            if curl -f -s -I "https://jitpack.io/com/github/btraceio/jfr-shell/$VERSION/jfr-shell-$VERSION.pom" > /dev/null; then
              echo "âœ“ JitPack artifact is available!"
              echo "Maven coordinate: io.github.btraceio:jfr-shell:$VERSION"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for artifact..."
            sleep 10
          done

          echo "âš  Warning: JitPack artifact not yet available after 5 minutes"
          echo "This is normal for first builds. Check status at:"
          echo "https://jitpack.io/com/github/btraceio/jfr-shell/$VERSION"
          exit 0

  create-catalog-update-pr:
    name: Create Catalog Update PR
    runs-on: ubuntu-latest
    needs: trigger-jitpack
    if: github.event_name == 'release'

    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create catalog update notice
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          cat << EOF

          ========================================
          ðŸ“¦ CATALOG UPDATE REQUIRED
          ========================================

          Version $VERSION has been published!

          Next steps:
          1. Update btraceio/jbang-catalog repository
          2. Edit jbang-catalog.json:

             "jfr-shell-jitpack": {
               "script-ref": "io.github.btraceio:jfr-shell:$VERSION",
               ...
             }

          3. Also update jfr-shell.java if needed:

             //DEPS io.github.btraceio:jfr-shell:$VERSION

          4. Commit and push the changes

          Test the release:
            jbang --fresh jfr-shell@btraceio --version
            jbang io.github.btraceio:jfr-shell:$VERSION --help

          ========================================
          EOF

      - name: Comment on release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const body = `## ðŸŽ‰ JBang Distribution Published

            This release has been published to:
            - âœ… GitHub Packages: \`io.jafar:jfr-shell:${version}\`
            - âœ… JitPack: \`io.github.btraceio:jfr-shell:${version}\`

            ### Usage

            \`\`\`bash
            # Via JBang catalog
            jbang jfr-shell@btraceio recording.jfr

            # Via JitPack (version pinned)
            jbang io.github.btraceio:jfr-shell:${version} recording.jfr

            # Install as command
            jbang app install jfr-shell@btraceio
            \`\`\`

            ### âš ï¸ Action Required

            The [btraceio/jbang-catalog](https://github.com/btraceio/jbang-catalog) needs to be updated with the new version:

            1. Edit \`jbang-catalog.json\`:
               \`\`\`json
               "jfr-shell-jitpack": {
                 "script-ref": "io.github.btraceio:jfr-shell:${version}",
                 "description": "JFR Shell via JitPack (version pinned)",
                 "java": "21+"
               }
               \`\`\`

            2. Edit \`jfr-shell.java\`:
               \`\`\`java
               //DEPS io.github.btraceio:jfr-shell:${version}
               \`\`\`

            3. Commit and push to update the catalog

            ### Verification

            Check JitPack build status: https://jitpack.io/com/github/btraceio/jfr-shell/${version}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.release.id,
              body: body
            });
