name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # Extract version from tag
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Extract version
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  # Publish core artifacts to Sonatype
  publish-maven:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME }}
      ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD }}
      ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEY }}
      ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYID }}
      ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYPASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Verify version matches tag
        run: |
          PROJECT_VERSION=$(grep "^project.version=" build.gradle | cut -d'"' -f2)
          if [ "$PROJECT_VERSION" != "${{ needs.prepare.outputs.version }}" ]; then
            echo "ERROR: Project version ($PROJECT_VERSION) doesn't match tag version (${{ needs.prepare.outputs.version }})"
            exit 1
          fi

      - name: Publish parser to Maven Local (for gradle plugin dependency)
        run: |
          ./gradlew :parser:jar :parser:sourcesJar :parser:publishToMavenLocal --no-daemon --stacktrace

      - name: Publish parser, tools, jfr-shell to Maven Central
        run: |
          ./gradlew :parser:publishAllPublicationsToMavenCentralRepository :tools:publishAllPublicationsToMavenCentralRepository :jfr-shell:shadowJar :jfr-shell:publishAllPublicationsToMavenCentralRepository --no-daemon --stacktrace

      - name: Publish gradle plugin to Maven Central and GitHub Packages
        run: |
          cd jafar-gradle-plugin
          ./gradlew publishAllPublicationsToMavenCentralRepository publishAllPublicationsToGitHubPackagesRepository --no-daemon --stacktrace
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYPASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

  # Build jfr-shell shadow JAR for JitPack
  publish-jfr-shell:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build shadow JAR
        run: ./gradlew :jfr-shell:shadowJar --no-daemon

      - name: Upload shadow JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jfr-shell-jar
          path: jfr-shell/build/libs/jfr-shell-*.jar
          retention-days: 30

  # Trigger JitPack build and wait for completion
  jitpack-build:
    needs: [prepare, publish-jfr-shell]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger JitPack build
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          echo "Triggering JitPack build for version: $VERSION (tag: $TAG)"

          # Trigger the build and capture output
          if curl -s -o /tmp/jitpack-build.log "https://jitpack.io/com/github/btraceio/jafar/$TAG/build.log"; then
            echo "JitPack build triggered successfully"
            echo "Build log preview:"
            head -50 /tmp/jitpack-build.log
          else
            echo "âš ï¸ Failed to fetch JitPack build log, but build may still be queued"
            echo "Check status at: https://jitpack.io/com/github/btraceio/jafar/$TAG"
          fi

      - name: Wait for JitPack artifact
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"
          echo "Waiting for JitPack artifact to be available..."

          # Wait up to 10 minutes for artifact
          for i in {1..60}; do
            if curl -f -s -I "https://jitpack.io/com/github/btraceio/jafar/$TAG/jafar-$TAG.pom" > /dev/null; then
              echo "âœ“ JitPack artifact is available!"
              echo "Maven coordinate: io.github.btraceio.jafar:jfr-shell:$TAG"
              exit 0
            fi
            echo "Attempt $i/60: Waiting for artifact..."
            sleep 10
          done

          echo "âš  Warning: JitPack artifact not available after 10 minutes"
          echo "Check status at: https://jitpack.io/com/github/btraceio/jafar/$TAG"
          exit 1

  # Update JBang catalog automatically
  update-jbang-catalog:
    needs: [prepare, jitpack-build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout jbang-catalog
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: btraceio/jbang-catalog
          token: ${{ secrets.JBANG_CATALOG_PAT || secrets.GITHUB_TOKEN }}
          path: catalog

      - name: Update catalog files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.version_tag }}"

          cd catalog

          # Update jbang-catalog.json
          sed -i.bak "s|io.btrace:jfr-shell:[^\"]*|io.btrace:jfr-shell:$VERSION|g" jbang-catalog.json

          # Update jfr-shell.java
          sed -i.bak "s|//DEPS io.btrace:jfr-shell:.*|//DEPS io.btrace:jfr-shell:$VERSION|g" jfr-shell.java

          # Clean up backup files
          rm -f *.bak

          # Show changes
          git diff

      - name: Commit and push catalog updates
        continue-on-error: true
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          if [ ! -d catalog ]; then
            echo "âš ï¸ Catalog checkout failed - skipping update"
            echo "Add JBANG_CATALOG_PAT secret to enable automatic catalog updates"
            exit 0
          fi

          cd catalog

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add jbang-catalog.json jfr-shell.java
          if git commit -m "Update jfr-shell to version $VERSION"; then
            git push || echo "âš ï¸ Push failed - update catalog manually at https://github.com/btraceio/jbang-catalog"
          fi

  # Create GitHub Release with notes
  create-release:
    needs: [prepare, publish-maven, publish-jfr-shell, jitpack-build]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # Extract changelog section for this version
          awk "/## \[$VERSION\]/,/## \[/{if(/## \[/ && !/## \[$VERSION\]/)exit;print}" CHANGELOG.md > /tmp/release-notes.md

          # If empty, use a default message
          if [ ! -s /tmp/release-notes.md ]; then
            echo "Release $VERSION" > /tmp/release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.version_tag }}
          name: Release ${{ needs.prepare.outputs.version }}
          body_path: /tmp/release-notes.md
          files: |
            **/build/libs/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add release comment
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.prepare.outputs.version }}';
            const tag = '${{ needs.prepare.outputs.version_tag }}';

            const body = `## ðŸŽ‰ Release ${version} Published Successfully

            This release has been published to:
            - âœ… Maven Central (Sonatype): \`io.btrace:jafar-parser:${version}\`, \`io.btrace:jafar-tools:${version}\`, \`io.btrace:jfr-shell:${version}\`
            - âœ… GitHub Packages: \`io.btrace:jfr-shell:${version}\`
            - âœ… JBang Catalog: Updated to ${version}

            ### Usage

            **Via JBang (recommended):**
            \`\`\`bash
            # Using catalog (always latest)
            jbang jfr-shell@btraceio recording.jfr

            # Version pinned
            jbang io.btrace:jfr-shell:${version} recording.jfr

            # Install as command
            jbang app install jfr-shell@btraceio
            jfr-shell recording.jfr
            \`\`\`

            **Via Maven/Gradle:**
            \`\`\`xml
            <!-- Parser -->
            <dependency>
              <groupId>io.btrace</groupId>
              <artifactId>jafar-parser</artifactId>
              <version>${version}</version>
            </dependency>

            <!-- JFR Shell -->
            <dependency>
              <groupId>io.btrace</groupId>
              <artifactId>jfr-shell</artifactId>
              <version>${version}</version>
            </dependency>
            \`\`\`

            ### Links
            - ðŸ“¦ [JitPack Build](https://jitpack.io/com/github/btraceio/jafar/${tag})
            - ðŸ“š [Documentation](https://github.com/btraceio/jafar#readme)
            - ðŸ”– [Changelog](https://github.com/btraceio/jafar/blob/${tag}/CHANGELOG.md)`;

            // Find the release and add a comment
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const release = releases.data.find(r => r.tag_name === tag);
            if (release) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: release.body + '\n\n' + body
              });
            }
